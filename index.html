import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInWithEmailAndPassword, 
  onAuthStateChanged, 
  signOut 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  onSnapshot, 
  query, 
  orderBy, 
  doc, 
  updateDoc, 
  deleteDoc,
  serverTimestamp,
  where,
  writeBatch,
  getDocs // Perlu untuk clearOldLoans
} from 'firebase/firestore';
import {
  getStorage,
  ref,
  uploadBytesResumable,
  getDownloadURL,
  deleteObject // Untuk memadam gambar lama jika perlu
} from 'firebase/storage';

// --- Konfigurasi Firebase ---
// (Nota: Akaun admin 'gurubesar@sksa.com' & 'guruict@sksa.com' mesti
// dibuat secara manual di dalam Firebase Authentication Console)
const firebaseConfig = typeof __firebase_config !== 'undefined' 
  ? JSON.parse(__firebase_config) 
  : {
      apiKey: "AIzaSyCV5skKQO1i-T6pOckTEyhDG8H4fh7vS7s",
      authDomain: "sistem-pinjaman-aset-ict-v2.firebaseapp.com",
      projectId: "sistem-pinjaman-aset-ict-v2",
      storageBucket: "sistem-pinjaman-aset-ict-v2.firebasestorage.app",
      messagingSenderId: "1013418266777",
      appId: "1:1013418266777:web:f3ec4d5f38fe7b87b76808",
      measurementId: "G-9CQDWM207Z"
    };

// Dapatkan ID Apl
const appId = typeof __app_id !== 'undefined' ? __app_id : 'sistem-pinjaman-ict';

// --- Inisialisasi Firebase ---
let app, auth, db, storage;
try {
  app = initializeApp(firebaseConfig);
  auth = getAuth(app);
  db = getFirestore(app);
  storage = getStorage(app); // Inisialisasi Firebase Storage
} catch (error) {
  console.error("Ralat Inisialisasi Firebase:", error);
}

// --- Koleksi Firestore ---
// DIKEMAS KINI: Laluan (path) ditukar kepada 'asetICT' dan 'loans'
const getLoansCollection = () => collection(db, `artifacts/${appId}/public/data/loans`);
const getAssetsCollection = () => collection(db, `artifacts/${appId}/public/data/asetICT`); // Ditukar dari 'items'
const getLoanDoc = (id) => doc(db, `artifacts/${appId}/public/data/loans/${id}`);
const getAssetDoc = (id) => doc(db, `artifacts/${appId}/public/data/asetICT/${id}`); // Ditukar dari 'items'

// --- Komponen Bantuan ---

// Komponen Modal
const Modal = ({ isOpen, onClose, title, children }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60" onClick={onClose}>
      <div className="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 m-4 overflow-y-auto max-h-[90vh]" onClick={(e) => e.stopPropagation()}>
        <h3 className="text-xl font-medium leading-6 text-gray-900 mb-4">{title}</h3>
        <div className="text-sm text-gray-600">{children}</div>
      </div>
    </div>
  );
};

// Komponen Spinner
const Spinner = () => (
  <div className="flex justify-center items-center p-10">
    <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-600"></div>
  </div>
);

// Format Tarikh
const formatDate = (timestamp) => {
  if (!timestamp) return 'N/A';
  const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
  return date.toLocaleDateString('ms-MY', { day: '2-digit', month: '2-digit', year: 'numeric' });
};

// --- Komponen Teras: Mod Guru ---

// Borang Permohonan Pinjaman
const LoanForm = ({ assets, onSubmitSuccess }) => {
  const [formData, setFormData] = useState({
    namaGuru: '',
    noKP: '',
    tarikhPinjam: '',
    tarikhPulang: '',
    tujuan: '',
    asetId: '',
  });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  // Sediakan senarai aset untuk <select>, hanya yang ada 'jumlah' > 0
  const availableAssets = useMemo(() => {
    return assets.filter(a => a.jumlah > 0);
  }, [assets]);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!formData.asetId) {
      setError("Sila pilih aset ICT.");
      return;
    }
    setLoading(true);
    setError('');

    try {
      const selectedAsset = assets.find(a => a.id === formData.asetId);
      if (!selectedAsset) throw new Error("Aset tidak ditemui.");
      
      // Semak jika tarikh pulang sebelum tarikh pinjam
      if (new Date(formData.tarikhPulang) < new Date(formData.tarikhPinjam)) {
        setError("Tarikh pulang tidak boleh lebih awal dari tarikh pinjam.");
        setLoading(false);
        return;
      }

      await addDoc(getLoansCollection(), {
        ...formData,
        asetNama: selectedAsset.nama, // Simpan nama aset untuk rujukan
        status: 'Baharu', // Status: Baharu, Diluluskan, Ditolak, Selesai
        timestamp: serverTimestamp(),
      });
      
      onSubmitSuccess();
      setFormData({
        namaGuru: '', noKP: '', tarikhPinjam: '', tarikhPulang: '', tujuan: '', asetId: '',
      });
    } catch (err) {
      console.error("Ralat menghantar permohonan:", err);
      setError("Permohonan gagal dihantar. Sila cuba lagi.");
    }
    setLoading(false);
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      {/* ... (Medan Borang Nama, KP, Tarikh, Tujuan dikekalkan seperti asal) ... */}
      <div>
        <label htmlFor="namaGuru" className="block text-sm font-medium text-gray-700">Nama Guru</label>
        <input type="text" name="namaGuru" id="namaGuru" value={formData.namaGuru} onChange={handleChange} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
      </div>
      <div>
        <label htmlFor="noKP" className="block text-sm font-medium text-gray-700">No Kad Pengenalan</label>
        <input type="text" name="noKP" id="noKP" value={formData.noKP} onChange={handleChange} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label htmlFor="tarikhPinjam" className="block text-sm font-medium text-gray-700">Tarikh Pinjam</label>
          <input type="date" name="tarikhPinjam" id="tarikhPinjam" value={formData.tarikhPinjam} onChange={handleChange} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
        </div>
        <div>
          <label htmlFor="tarikhPulang" className="block text-sm font-medium text-gray-700">Tarikh Pulang</label>
          <input type="date" name="tarikhPulang" id="tarikhPulang" value={formData.tarikhPulang} onChange={handleChange} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
        </div>
      </div>
      <div>
        <label htmlFor="tujuan" className="block text-sm font-medium text-gray-700">Tujuan Pinjaman</label>
        <textarea name="tujuan" id="tujuan" rows="3" value={formData.tujuan} onChange={handleChange} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
      </div>
      <div>
        <label htmlFor="asetId" className="block text-sm font-medium text-gray-700">Pilih Aset ICT</label>
        <select
          name="asetId"
          id="asetId"
          value={formData.asetId}
          onChange={handleChange}
          required
          className="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
        >
          <option value="">-- Sila Pilih Aset --</option>
          {availableAssets.map(asset => (
            <option key={asset.id} value={asset.id}>
              {asset.nama} ({asset.kategori}) - {asset.jumlah} tersedia
            </option>
          ))}
        </select>
      </div>
      {error && <p className="text-red-600 text-sm">{error}</p>}
      <button
        type="submit"
        disabled={loading}
        className="w-full px-6 py-3 bg-green-600 text-white rounded-md font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:bg-gray-400"
      >
        {loading ? "Menghantar..." : "Hantar Permohonan"}
      </button>
    </form>
  );
};

// [BARU] Komponen Kad Aset
const AssetCard = ({ asset }) => {
  const placeholderImage = "https://placehold.co/600x400/e2e8f0/64748b?text=Tiada+Gambar";
  return (
    <div className="bg-white shadow-lg rounded-lg overflow-hidden transition-shadow duration-300 hover:shadow-xl">
      <img
        src={asset.gambarURL || placeholderImage}
        alt={asset.nama}
        className="w-full h-48 object-cover"
        onError={(e) => { e.target.onerror = null; e.target.src = placeholderImage; }}
      />
      <div className="p-4">
        <h4 className="text-lg font-semibold text-gray-800 truncate" title={asset.nama}>
          üíª {asset.nama}
        </h4>
        <p className="text-sm text-gray-500 mb-2">
          <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold">
            üìÅ {asset.kategori}
          </span>
        </p>
        <p className="text-sm text-gray-600 mb-3" title={asset.spesifikasi}>
          <span className="font-medium">Spesifikasi:</span> {asset.spesifikasi ? asset.spesifikasi.substring(0, 50) + '...' : 'N/A'}
        </p>
        <div className="flex justify-between items-center">
          <span className="text-base font-bold text-blue-700">üì¶ {asset.jumlah} Unit</span>
        </div>
      </div>
    </div>
  );
};

// [DIKEMAS KINI] Paparan Senarai Aset (untuk Guru) - Guna Kad
const AssetListDisplay = ({ assets, loading }) => {
  return (
    <div className="bg-white shadow-lg rounded-lg p-6">
      <h3 className="text-xl font-semibold text-gray-800 mb-4">Aset ICT Tersedia</h3>
      {loading ? <Spinner /> : (
        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
          {assets.length > 0 ? assets.map(asset => (
            <AssetCard key={asset.id} asset={asset} />
          )) : (
            <p className="text-gray-500 col-span-full text-center">Tiada aset tersedia pada masa ini.</p>
          )}
        </div>
      )}
    </div>
  );
};

// Halaman Utama Guru
const TeacherPage = ({ assets, loadingAssets, onSubmitSuccess }) => {
  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
      {/* Kiri: Borang Permohonan */}
      <div className="bg-white shadow-lg rounded-lg p-6 lg:p-8">
        <h2 className="text-2xl font-bold text-gray-900 mb-6">Borang Permohonan Pinjaman Aset ICT</h2>
        <LoanForm assets={assets} onSubmitSuccess={onSubmitSuccess} />
      </div>
      
      {/* Kanan: Senarai Aset (Guna Kad) */}
      <div className="lg:pt-8">
        <AssetListDisplay assets={assets} loading={loadingAssets} />
      </div>
    </div>
  );
};


// --- Komponen Teras: Mod Admin ---

// Halaman Log Masuk Admin
const AdminLoginPage = ({ setCurrentView }) => {
  // ... (Kod dikekalkan seperti asal) ...
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleLogin = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');
    try {
      // Cuba log masuk dengan akaun yang disediakan
      await signInWithEmailAndPassword(auth, email, password);
    } catch (err) {
      setError("Log masuk gagal. Sila semak emel dan kata laluan anda.");
      console.error("Ralat log masuk:", err);
      setLoading(false);
    }
  };

  return (
    <div className="flex justify-center items-center pt-10">
      <div className="w-full max-w-md bg-white shadow-lg rounded-lg p-8">
        <h2 className="text-2xl font-bold text-center text-gray-900 mb-6">Log Masuk Admin</h2>
        <form onSubmit={handleLogin} className="space-y-4">
          <div>
            <label htmlFor="email" className="block text-sm font-medium text-gray-700">Emel</label>
            <input type="email" id="email" value={email} onChange={(e) => setEmail(e.target.value)} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
          </div>
          <div>
            <label htmlFor="password" className="block text-sm font-medium text-gray-700">Kata Laluan</label>
            <input type="password" id="password" value={password} onChange={(e) => setPassword(e.target.value)} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
          </div>
          {error && <p className="text-red-600 text-sm">{error}</p>}
          <button type="submit" disabled={loading} className="w-full px-6 py-3 bg-blue-600 text-white rounded-md font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-400">
            {loading ? "Memproses..." : "Log Masuk"}
          </button>
        </form>
      </div>
    </div>
  );
};

// Komponen Senarai Permohonan (Admin)
const LoanRequestList = ({ loans, loading, onUpdateStatus, onClearOld }) => {
  // ... (Kod dikekalkan seperti asal, menggunakan paparan jadual untuk permohonan) ...
  const filterLoans = (status) => loans.filter(loan => loan.status === status);
  const newLoans = filterLoans('Baharu');
  const approvedLoans = filterLoans('Diluluskan');
  const historyLoans = loans.filter(loan => loan.status === 'Ditolak' || loan.status === 'Selesai');

  const renderLoanRow = (loan) => (
    <tr key={loan.id} className="hover:bg-gray-50">
      <td className="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
        {loan.namaGuru}
        <span className="block text-xs text-gray-500">{loan.noKP}</span>
      </td>
      <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-600">{loan.asetNama}</td>
      <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-600">
        {loan.tarikhPinjam} - {loan.tarikhPulang}
      </td>
      <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-600 max-w-xs truncate" title={loan.tujuan}>{loan.tujuan}</td>
      <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-600">{formatDate(loan.timestamp)}</td>
      <td className="px-4 py-3 whitespace-nowrap text-sm font-medium space-x-2">
        {loan.status === 'Baharu' && (
          <>
            <button onClick={() => onUpdateStatus(loan.id, 'Diluluskan')} className="text-green-600 hover:text-green-800">Lulus</button>
            <button onClick={() => onUpdateStatus(loan.id, 'Ditolak')} className="text-red-600 hover:text-red-800">Tolak</button>
          </>
        )}
        {loan.status === 'Diluluskan' && (
          <button onClick={() => onUpdateStatus(loan.id, 'Selesai')} className="text-blue-600 hover:text-blue-800">Tanda Selesai</button>
        )}
      </td>
    </tr>
  );

  const renderHistoryRow = (loan) => (
    <tr key={loan.id} className="hover:bg-gray-50">
      <td className="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">{loan.namaGuru}</td>
      <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-600">{loan.asetNama}</td>
      <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-600">{formatDate(loan.timestamp)}</td>
      <td className="px-4 py-3 whitespace-nowrap text-sm font-medium">
        {loan.status === 'Selesai' && <span className="text-green-700">Selesai</span>}
        {loan.status === 'Ditolak' && <span className="text-red-700">Ditolak</span>}
      </td>
    </tr>
  );

  return (
    <div className="space-y-8">
      {loading && <Spinner />}
      {/* ... (Jadual untuk Permohonan Baharu, Diluluskan, Rekod dikekalkan seperti asal) ... */}
      {/* Permohonan Baharu */}
      <div className="bg-white shadow-lg rounded-lg overflow-hidden">
        <h3 className="text-lg font-semibold text-gray-800 p-4 bg-gray-50 border-b">Permohonan Baharu</h3>
        <div className="overflow-x-auto">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Guru</th>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Aset</th>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Tarikh</th>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Tujuan</th>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Dihantar</th>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Tindakan</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {newLoans.length > 0 ? newLoans.map(renderLoanRow) : (
                <tr><td colSpan="6" className="text-center p-4 text-gray-500">Tiada permohonan baharu.</td></tr>
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* Pinjaman Diluluskan (Belum Pulang) */}
      <div className="bg-white shadow-lg rounded-lg overflow-hidden">
        <h3 className="text-lg font-semibold text-gray-800 p-4 bg-gray-50 border-b">Pinjaman Diluluskan (Belum Pulang)</h3>
        <div className="overflow-x-auto">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Guru</th>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Aset</th>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Tarikh</th>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Tujuan</th>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Dihantar</th>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Tindakan</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {approvedLoans.length > 0 ? approvedLoans.map(renderLoanRow) : (
                <tr><td colSpan="6" className="text-center p-4 text-gray-500">Tiada pinjaman yang sedang aktif.</td></tr>
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* Rekod Pinjaman (Selesai / Ditolak) */}
      <div className="bg-white shadow-lg rounded-lg overflow-hidden">
        <div className="flex justify-between items-center p-4 bg-gray-50 border-b">
          <h3 className="text-lg font-semibold text-gray-800">Rekod Pinjaman (Arkib)</h3>
          <button onClick={onClearOld} className="px-3 py-1 text-sm bg-red-500 text-white rounded-md hover:bg-red-600">
            Kosongkan Rekod Lama
          </button>
        </div>
        <div className="overflow-x-auto">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Guru</th>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Aset</th>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Dihantar</th>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Status</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {historyLoans.length > 0 ? historyLoans.map(renderHistoryRow) : (
                <tr><td colSpan="4" className="text-center p-4 text-gray-500">Tiada rekod sejarah.</td></tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
};

// [DIKEMAS KINI BESAR] Komponen Pengurusan Aset (Admin) - Guna Kad & Storan
const AssetManagement = ({ assets, loading, onAddAsset, onUpdateAsset, onDeleteAsset }) => {
  const [showAddModal, setShowAddModal] = useState(false);
  const [editAsset, setEditAsset] = useState(null); // { id, nama, jumlah, kategori, ... }

  const kategoriOptions = ["Laptop", "Tablet", "Projector", "Lain-lain"];
  const placeholderImage = "https://placehold.co/600x400/e2e8f0/64748b?text=Tiada+Gambar";

  // Komponen borang dalaman untuk Tambah/Edit
  const AssetForm = ({ initialData, onSubmit, onCancel, isEditing }) => {
    const [formData, setFormData] = useState(
      initialData || { nama: '', jumlah: 1, kategori: 'Laptop', spesifikasi: '', gambarURL: '' }
    );
    const [imageFile, setImageFile] = useState(null); // Fail gambar baharu
    const [uploadProgress, setUploadProgress] = useState(0);
    const [formLoading, setFormLoading] = useState(false);

    const handleChange = (e) => {
      const { name, value } = e.target;
      setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleFileChange = (e) => {
      if (e.target.files[0]) {
        setImageFile(e.target.files[0]);
      }
    };

    const handleSubmit = async (e) => {
      e.preventDefault();
      setFormLoading(true);
      
      let finalGambarURL = formData.gambarURL; // Kekalkan gambar sedia ada

      if (imageFile) {
        // Jika ada fail baharu, muat naik
        try {
          const storageRef = ref(storage, `aset-images/${appId}/${Date.now()}_${imageFile.name}`);
          const uploadTask = uploadBytesResumable(storageRef, imageFile);

          await new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
              (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                setUploadProgress(progress);
              },
              (error) => {
                console.error("Upload failed:", error);
                reject(error);
              },
              async () => {
                finalGambarURL = await getDownloadURL(uploadTask.snapshot.ref);
                resolve();
              }
            );
          });
          
          // TODO: Padam gambar lama dari storage jika edit dan gambar baharu dimuat naik
          
        } catch (err) {
          console.error("Ralat muat naik gambar:", err);
          setFormLoading(false);
          return; // Hentikan jika gagal muat naik
        }
      }

      // Hantar data ke fungsi 'App'
      await onSubmit({
        ...formData,
        jumlah: parseInt(formData.jumlah, 10),
        gambarURL: finalGambarURL
      });
      
      setFormLoading(false);
      onCancel(); // Tutup modal
    };

    return (
      <form onSubmit={handleSubmit} className="space-y-4">
        <div>
          <label htmlFor="nama" className="block text-sm font-medium text-gray-700">Nama Aset</label>
          <input type="text" id="nama" name="nama" value={formData.nama} onChange={handleChange} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" />
        </div>
        <div>
          <label htmlFor="kategori" className="block text-sm font-medium text-gray-700">Kategori</label>
          <select id="kategori" name="kategori" value={formData.kategori} onChange={handleChange} className="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm">
            {kategoriOptions.map(kat => <option key={kat} value={kat}>{kat}</option>)}
          </select>
        </div>
        <div>
          <label htmlFor="jumlah" className="block text-sm font-medium text-gray-700">Jumlah</label>
          <input type="number" id="jumlah" name="jumlah" value={formData.jumlah} onChange={handleChange} min="0" required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" />
        </div>
        <div>
          <label htmlFor="spesifikasi" className="block text-sm font-medium text-gray-700">Spesifikasi</label>
          <textarea id="spesifikasi" name="spesifikasi" value={formData.spesifikasi} onChange={handleChange} rows="3" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
        </div>
        <div>
          <label htmlFor="gambar" className="block text-sm font-medium text-gray-700">Gambar Aset</label>
          {formData.gambarURL && !imageFile && (
            <img src={formData.gambarURL} alt="Preview" className="w-32 h-32 object-cover rounded-md my-2" />
          )}
          <input type="file" id="gambar" name="gambar" onChange={handleFileChange} accept="image/png, image/jpeg" className="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
        </div>
        {formLoading && (
          <div className="w-full bg-gray-200 rounded-full">
            <div className="bg-blue-600 text-xs font-medium text-blue-100 text-center p-0.5 leading-none rounded-full" style={{ width: `${uploadProgress}%` }}>
              {uploadProgress > 0 ? `${Math.round(uploadProgress)}%` : "Memuat naik..."}
            </div>
          </div>
        )}
        <div className="flex justify-end space-x-3 pt-4">
          <button type="button" onClick={onCancel} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md font-medium hover:bg-gray-300">
            Batal
          </button>
          <button type="submit" disabled={formLoading} className="px-4 py-2 bg-blue-600 text-white rounded-md font-medium hover:bg-blue-700 disabled:bg-gray-400">
            {formLoading ? "Menyimpan..." : (isEditing ? "Simpan Perubahan" : "Tambah Aset")}
          </button>
        </div>
      </form>
    );
  };

  return (
    <div className="bg-white shadow-lg rounded-lg">
      <div className="flex justify-between items-center p-4 bg-gray-50 border-b">
        <h3 className="text-lg font-semibold text-gray-800">Pengurusan Aset ICT</h3>
        <button
          onClick={() => setShowAddModal(true)}
          className="px-4 py-2 bg-green-600 text-white rounded-md font-medium hover:bg-green-700"
        >
          Tambah Aset
        </button>
      </div>

      {loading && <Spinner />}
      
      {/* [DIKEMAS KINI] Paparan Aset Guna Kad */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 p-6">
        {assets.map(asset => (
          <div key={asset.id} className="relative">
            <AssetCard asset={asset} />
            <div className="flex justify-center space-x-2 mt-2 p-2 bg-gray-50 rounded-b-md">
              <button onClick={() => setEditAsset(asset)} className="text-sm px-3 py-1 bg-blue-500 text-white rounded-md hover:bg-blue-600">Edit</button>
              <button onClick={() => onDeleteAsset(asset.id, asset.gambarURL)} className="text-sm px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600">Padam</button>
            </div>
          </div>
        ))}
      </div>

      {/* Modal Tambah Aset */}
      <Modal isOpen={showAddModal} onClose={() => setShowAddModal(false)} title="Tambah Aset Baharu">
        <AssetForm
          onSubmit={onAddAsset}
          onCancel={() => setShowAddModal(false)}
          isEditing={false}
        />
      </Modal>

      {/* Modal Edit Aset */}
      <Modal isOpen={!!editAsset} onClose={() => setEditAsset(null)} title="Edit Aset">
        {editAsset && (
          <AssetForm
            initialData={editAsset}
            onSubmit={(data) => onUpdateAsset(editAsset.id, data)}
            onCancel={() => setEditAsset(null)}
            isEditing={true}
          />
        )}
      </Modal>
    </div>
  );
};

// Komponen Dashboard Admin
const AdminDashboardPage = ({ assets, loans, loadingAssets, loadingLoans, handlers }) => {
  // ... (Kod dikekalkan seperti asal) ...
  const [adminView, setAdminView] = useState('rekodPinjaman'); // rekodPinjaman, urusAset

  return (
    <div className="space-y-6">
      {/* Navigasi Admin */}
      <div className="flex space-x-4 border-b-2 border-gray-200">
        <button
          onClick={() => setAdminView('rekodPinjaman')}
          className={`px-4 py-2 font-medium ${adminView === 'rekodPinjaman' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
        >
          Rekod Pinjaman
        </button>
        <button
          onClick={() => setAdminView('urusAset')}
          className={`px-4 py-2 font-medium ${adminView === 'urusAset' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
        >
          Urus Aset
        </button>
        <button
          onClick={handlers.onExportCSV}
          className="ml-auto px-4 py-2 bg-gray-600 text-white rounded-md font-medium hover:bg-gray-700 text-sm"
        >
          Eksport CSV
        </button>
      </div>

      {/* Paparan Kandungan Admin */}
      <div>
        {adminView === 'rekodPinjaman' && (
          <LoanRequestList
            loans={loans}
            loading={loadingLoans}
            onUpdateStatus={handlers.onUpdateLoanStatus}
            onClearOld={handlers.onClearOldLoans}
          />
        )}
        {adminView === 'urusAset' && (
          <AssetManagement
            assets={assets}
            loading={loadingAssets}
            onAddAsset={handlers.onAddAsset}
            onUpdateAsset={handlers.onUpdateAsset}
            onDeleteAsset={handlers.onDeleteAsset}
          />
        )}
      </div>
    </div>
  );
};


// --- Komponen Utama: App ---
function App() {
  const [user, setUser] = useState(null); // Objek user Firebase
  const [loadingAuth, setLoadingAuth] = useState(true);
  const [currentView, setCurrentView] = useState('permohonan'); // permohonan, adminLogin
  
  const [assets, setAssets] = useState([]);
  const [loadingAssets, setLoadingAssets] = useState(true);
  
  const [loans, setLoans] = useState([]);
  const [loadingLoans, setLoadingLoans] = useState(true);

  const [successModalOpen, setSuccessModalOpen] = useState(false);
  const [error, setError] = useState(null);

  // 1. Kesan Pengesahan (Authentication)
  useEffect(() => {
    // ... (Kod dikekalkan seperti asal) ...
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      if (currentUser) {
        setCurrentView('adminDashboard');
      } else if (currentView === 'adminDashboard') {
        setCurrentView('adminLogin');
      }
      setLoadingAuth(false);
    });
    return () => unsubscribe();
  }, [currentView]);

  // 2. Kesan Muat Turun Data (Aset)
  useEffect(() => {
    // ... (Kod dikekalkan seperti asal, tetapi kini merujuk 'getAssetsCollection') ...
    const q = query(getAssetsCollection(), orderBy('nama', 'asc'));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      setAssets(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
      setLoadingAssets(false);
    }, (err) => {
      console.error(err);
      setError("Gagal memuat turun data aset.");
      setLoadingAssets(false);
    });
    return () => unsubscribe();
  }, []);

  // 3. Kesan Muat Turun Data (Pinjaman)
  useEffect(() => {
    // ... (Kod dikekalkan seperti asal) ...
    if (user) { 
      setLoadingLoans(true);
      const q = query(getLoansCollection(), orderBy('timestamp', 'desc'));
      const unsubscribe = onSnapshot(q, (snapshot) => {
        setLoans(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        setLoadingLoans(false);
      }, (err) => {
        console.error(err);
        setError("Gagal memuat turun data pinjaman.");
        setLoadingLoans(false);
      });
      return () => unsubscribe();
    } else {
      setLoans([]); 
      setLoadingLoans(false);
    }
  }, [user]); 


  // --- Pengendali Logik (Handlers) ---

  const handleLogout = async () => {
    // ... (Kod dikekalkan seperti asal) ...
    await signOut(auth);
    setCurrentView('permohonan');
  };

  const handleLoanSubmitSuccess = () => {
    // ... (Kod dikekalkan seperti asal) ...
    setSuccessModalOpen(true);
  };

  // [DIKEMAS KINI] Pengendali untuk Mod Admin
  const adminHandlers = {
    // Pengendali Pinjaman
    onUpdateLoanStatus: async (id, status) => {
      // ... (Kod dikekalkan seperti asal) ...
      try {
        await updateDoc(getLoanDoc(id), { status: status });
      } catch (err) {
        console.error("Ralat kemaskini status:", err);
        setError("Gagal mengemaskini status.");
      }
    },
    onClearOldLoans: async () => {
      // ... (Kod dikekalkan seperti asal) ...
      if (!window.confirm("Anda pasti mahu memadam semua rekod yang telah 'Selesai' atau 'Ditolak'? Tindakan ini tidak boleh diundur.")) {
        return;
      }
      try {
        const q = query(getLoansCollection(), where('status', 'in', ['Selesai', 'Ditolak']));
        const snapshot = await getDocs(q); // Pastikan getDocs diimport
        const batch = writeBatch(db);
        snapshot.docs.forEach(doc => {
          batch.delete(doc.ref);
        });
        await batch.commit();
      } catch (err) {
        console.error("Ralat memadam rekod lama:", err);
        setError("Gagal memadam rekod lama.");
      }
    },
    
    // [DIKEMAS KINI] Pengendali Aset (termasuk spesifikasi/gambar)
    onAddAsset: async (assetData) => {
      try {
        await addDoc(getAssetsCollection(), {
          ...assetData,
          createdAt: serverTimestamp()
        });
      } catch (err) {
        console.error("Ralat menambah aset:", err);
        setError("Gagal menambah aset.");
      }
    },
    onUpdateAsset: async (id, assetData) => {
      try {
        await updateDoc(getAssetDoc(id), assetData);
      } catch (err) {
        console.error("Ralat mengemaskini aset:", err);
        setError("Gagal mengemaskini aset.");
      }
    },
    onDeleteAsset: async (id, gambarURL) => {
      if (window.confirm("Anda pasti mahu memadam aset ini?")) {
        try {
          // 1. Padam dokumen dari Firestore
          await deleteDoc(getAssetDoc(id));
          
          // 2. Padam gambar dari Storage (jika ada)
          if (gambarURL) {
            const imageRef = ref(storage, gambarURL);
            await deleteObject(imageRef).catch((err) => {
              // Mungkin gagal jika peraturan storage tidak betul, tapi teruskan
              console.warn("Gagal memadam gambar lama:", err);
            });
          }
        } catch (err) {
          console.error("Ralat memadam aset:", err);
          setError("Gagal memadam aset.");
        }
      }
    },

    // Pengendali Eksport
    onExportCSV: () => {
      // ... (Kod dikekalkan seperti asal) ...
      if (loans.length === 0) {
        alert("Tiada data untuk dieksport.");
        return;
      }
      let csvContent = "data:text/csv;charset=utf-8,";
      const headers = ["ID", "Nama Guru", "No KP", "Aset", "Tarikh Pinjam", "Tarikh Pulang", "Tujuan", "Status", "Tarikh Mohon (DD/MM/YYYY)"];
      csvContent += headers.join(",") + "\r\n";
      loans.forEach(loan => {
        const row = [
          loan.id,
          `"${loan.namaGuru || ''}"`,
          `"${(loan.noKP || '').toString()}"`,
          `"${loan.asetNama || ''}"`,
          `"${loan.tarikhPinjam || ''}"`,
          `"${loan.tarikhPulang || ''}"`,
          `"${(loan.tujuan || '').replace(/"/g, '""')}"`,
          `"${loan.status || ''}"`,
          `"${formatDate(loan.timestamp)}"`
        ];
        csvContent += row.join(",") + "\r\n";
      });
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "rekod_pinjaman_ict.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  };

  // --- Logik Paparan (Render Logic) ---

  const renderView = () => {
    // ... (Kod dikekalkan seperti asal) ...
    if (loadingAuth) {
      return <Spinner />;
    }
    switch (currentView) {
      case 'permohonan':
        return <TeacherPage assets={assets} loadingAssets={loadingAssets} onSubmitSuccess={handleLoanSubmitSuccess} />;
      case 'adminLogin':
        return <AdminLoginPage setCurrentView={setCurrentView} />;
      case 'adminDashboard':
        if (!user) return <AdminLoginPage setCurrentView={setCurrentView} />;
        return <AdminDashboardPage 
                  assets={assets}
                  loans={loans}
                  loadingAssets={loadingAssets}
                  loadingLoans={loadingLoans}
                  handlers={adminHandlers}
                />;
      default:
        return <TeacherPage assets={assets} loadingAssets={loadingAssets} onSubmitSuccess={handleLoanSubmitSuccess} />;
    }
  };
  
  return (
    <div className="bg-gray-100 min-h-screen font-sans">
      {/* Navbar Utama */}
      <nav className="bg-blue-700 text-white shadow-md">
        <div className="container mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center h-16">
            <div className="flex-shrink-0 flex items-center">
              {/* [DIKEMAS KINI] Tajuk projek */}
              <span className="text-xl font-bold">Sistem Pinjaman Aset ICT (SK Sri Aman)</span>
            </div>
            <div className="flex items-center space-x-4">
              <button
                onClick={() => setCurrentView('permohonan')}
                className={`px-3 py-2 rounded-md text-sm font-medium ${currentView === 'permohonan' ? 'bg-blue-800' : 'hover:bg-blue-600'}`}
              >
                Permohonan Pinjaman
              </button>
              
              {user ? (
                <>
                  <button
                    onClick={() => setCurrentView('adminDashboard')}
                    className={`px-3 py-2 rounded-md text-sm font-medium ${currentView === 'adminDashboard' ? 'bg-blue-800' : 'hover:bg-blue-600'}`}
                  >
                    Dashboard Admin
                  </button>
                  <button
                    onClick={handleLogout}
                    className="px-3 py-2 rounded-md text-sm font-medium bg-red-600 hover:bg-red-700"
                  >
                    Log Keluar
                  </button>
                </>
              ) : (
                <button
                  onClick={() => setCurrentView('adminLogin')}
                  className={`px-3 py-2 rounded-md text-sm font-medium ${currentView === 'adminLogin' ? 'bg-blue-800' : 'hover:bg-blue-600'}`}
                >
                  Log Masuk Admin
                </button>
              )}
            </div>
          </div>
        </div>
      </nav>

      {/* Kandungan Utama */}
      <main className="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {error && (
          <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mb-4" role="alert">
            <strong className="font-bold">Ralat:</strong>
            <span className="block sm:inline"> {error}</span>
            <button onClick={() => setError(null)} className="float-right font-bold text-lg">&times;</button>
          </div>
        )}
        {renderView()}
      </main>

      {/* Modal Kejayaan */}
      <Modal 
        isOpen={successModalOpen} 
        onClose={() => setSuccessModalOpen(false)}
        title="Permohonan Dihantar"
      >
        <p>‚úÖ Permohonan anda telah berjaya dihantar. Sila tunggu kelulusan daripada pihak admin.</p>
      </Modal>
    </div>
  );
}

export default App;

