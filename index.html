<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pinjaman ICT - SK Sri Aman</title>
    <!-- Muat turun Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Muat turun Fon Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Muat turun Tone.js (untuk notifikasi bunyi) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <style>
        /* Tetapkan fon lalai */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F0F9FF; /* bg-blue-50 */
        }
        /* Sembunyikan 'number' input spinners */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Animasi 'spin' untuk ikon 'loading' */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin 2s linear infinite;
        }
        /* Sembunyikan 'scrollbar' sambil mengekalkan 'scrolling' */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- 1. PAPARAN LOADING (SEBELUM FIREBASE SEDIA) -->
    <div id="loading-view" class="flex items-center justify-center min-h-screen bg-blue-50">
        <div class="flex flex-col items-center space-y-4">
            <!-- Ikon SVG 'loading' -->
            <svg class="animate-spin-slow h-12 w-12 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg font-medium text-blue-700">Menyambung ke pelayan...</p>
        </div>
    </div>

    <!-- 2. PAPARAN LOG MASUK (JIKA TIADA PENGGUNA) -->
    <div id="auth-view" class="hidden min-h-screen bg-gradient-to-br from-blue-100 via-white to-blue-100 flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 border border-gray-200">
            <div class="flex flex-col items-center">
                <!-- Logo Sekolah (Placeholder) -->
                <div class="bg-blue-600 p-3 rounded-full mb-4">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.523 5.754 18 7.5 18s3.332.523 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.523 18.246 18 16.5 18c-1.746 0-3.332.523-4.5 1.253"></path></svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-900 mb-1">Sistem Pinjaman ICT</h1>
                <p class="text-sm text-gray-500 mb-6">SK Sri Aman</p>

                <div class="w-full space-y-4">
                    <!-- Butang Log Masuk Pentadbir (Google) -->
                    <button id="google-signin-btn" class="w-full flex items-center justify-center bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium py-3 px-4 rounded-lg shadow-sm transition duration-200">
                        <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.92-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                        Log Masuk sebagai Pentadbir (Google)
                    </button>
                    
                    <!-- Butang Log Masuk Guru (Anonymous) -->
                    <button id="anonymous-signin-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow transition duration-200">
                        Masuk sebagai Guru (Mod Pinjam)
                    </button>
                </div>

                <p class="text-xs text-gray-400 mt-8 text-center">Sila log masuk menggunakan akaun MOE (jika pentadbir) atau sebagai guru untuk meminjam.</p>
            </div>
        </div>
    </div>

    <!-- 3. PAPARAN UTAMA APLIKASI (SELEPAS LOG MASUK) -->
    <div id="app-view" class="hidden">
        
        <!-- Navbar Utama -->
        <nav class="bg-white shadow-md sticky top-0 z-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <!-- Bahagian Kiri: Logo & Tajuk -->
                    <div class="flex items-center">
                        <div class="flex-shrink-0 flex items-center">
                            <div class="bg-blue-600 p-2 rounded-lg">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.523 5.754 18 7.5 18s3.332.523 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.523 18.246 18 16.5 18c-1.746 0-3.332.523-4.5 1.253"></path></svg>
                            </div>
                            <span class="ml-3 text-xl font-bold text-gray-900 hidden sm:block">Sistem Pinjaman ICT</span>
                        </div>
                    </div>
                    
                    <!-- Bahagian Kanan: Info Pengguna & Butang Log Keluar -->
                    <div class="flex items-center">
                        <div class="text-right mr-4">
                            <div id="user-email-display" class="text-sm font-medium text-gray-900 truncate max-w-[200px]" title="Alamat E-mel Pengguna">
                                memuatkan...
                            </div>
                            <div id="user-role-display" class="text-xs font-medium text-blue-600">
                                memuatkan...
                            </div>
                        </div>
                        <button id="signout-btn" title="Log Keluar" class="p-2 rounded-full text-gray-500 hover:bg-red-100 hover:text-red-600 transition duration-200">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Konten Utama -->
        <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
            
            <!-- Bahagian 1: Borang Permohonan Pinjaman (Untuk Semua Pengguna) -->
            <section id="loan-request-section" class="mb-8">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-900 mb-5">Borang Permohonan Pinjaman</h2>
                    
                    <form id="new-loan-form" class="grid grid-cols-1 md:grid-cols-3 gap-5">
                        <!-- Kolum 1: Nama & Kelas -->
                        <div class="space-y-4">
                            <div>
                                <label for="new-loan-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Pemohon</label>
                                <input type="text" id="new-loan-name" required placeholder="Cth: Cikgu Ahmad"
                                       class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="new-loan-class" class="block text-sm font-medium text-gray-700 mb-1">Kelas/Tujuan (jika berkenaan)</label>
                                <input type="text" id="new-loan-class" placeholder="Cth: 6 Bestari / Mesyuarat PIBG"
                                       class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                        </div>
                        
                        <!-- Kolum 2: Aset & Tujuan -->
                        <div class="space-y-4">
                            <div>
                                <label for="new-loan-asset" class="block text-sm font-medium text-gray-700 mb-1">Aset Hendak Dipinjam</label>
                                <select id="new-loan-asset" required
                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="" disabled selected>Pilih aset...</option>
                                    <!-- Pilihan aset akan dimuatkan oleh JavaScript -->
                                </select>
                            </div>
                            <div>
                                <label for="new-loan-purpose" class="block text-sm font-medium text-gray-700 mb-1">Tujuan Pinjaman</label>
                                <input type="text" id="new-loan-purpose" required placeholder="Cth: PdPc Matematik di Makmal Komputer"
                                       class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                        </div>
                        
                        <!-- Kolum 3: Butang Hantar -->
                        <div class="md:flex md:items-end">
                            <div class="w-full">
                                <button type="submit" id="new-loan-submit"
                                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow transition duration-200 flex items-center justify-center">
                                    Hantar Permohonan
                                </button>
                                <p id="new-loan-status" class="text-sm text-green-600 mt-2 text-center"></p>
                            </div>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Bahagian 2: Senarai Pinjaman (Untuk Semua Pengguna) -->
            <section id="loan-lists-section" class="mb-8">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Kolum 1: Menunggu Kelulusan -->
                    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Menunggu Kelulusan</h3>
                        <div id="loan-list-pending" class="space-y-3 max-h-80 overflow-y-auto no-scrollbar">
                            <!-- Kad pinjaman 'pending' akan dimuatkan di sini -->
                            <p class="text-gray-500 text-sm">Tiada permohonan baharu.</p>
                        </div>
                    </div>
                    
                    <!-- Kolum 2: Sedang Dipinjam (Diluluskan) -->
                    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Sedang Dipinjam</h3>
                        <div id="loan-list-approved" class="space-y-3 max-h-80 overflow-y-auto no-scrollbar">
                            <!-- Kad pinjaman 'approved' akan dimuatkan di sini -->
                            <p class="text-gray-500 text-sm">Tiada aset sedang dipinjam.</p>
                        </div>
                    </div>
                    
                    <!-- Kolum 3: Sejarah Pinjaman (Dipulang/Ditolak) -->
                    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Sejarah & Ditolak</h3>
                        <div id="loan-list-history" class="space-y-3 max-h-80 overflow-y-auto no-scrollbar">
                            <!-- Kad pinjaman 'returned'/'rejected' akan dimuatkan di sini -->
                            <p class="text-gray-500 text-sm">Tiada sejarah pinjaman.</p>
                        </div>
                    </div>

                </div>
            </section>

            <!-- Bahagian 3: Paparan Aset (Untuk Semua Pengguna) -->
            <section id="asset-display-section" class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-5">Aset Tersedia Untuk Pinjaman</h2>
                <div id="asset-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
                    <!-- Kad aset akan dimuatkan di sini -->
                    <p class="text-gray-500 text-sm col-span-full">Memuatkan senarai aset...</p>
                </div>
            </section>

            <!-- Bahagian 4: Kawalan Pentadbir (Hanya Admin) -->
            <section id="admin-panel-section" class="admin-controls hidden">
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6 pb-3 border-b-2 border-blue-600">
                    Panel Kawalan Pentadbir
                </h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    <!-- Kolum 1: Tambah Aset Baharu -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-900 mb-5">Tambah Aset Baharu</h3>
                        <form id="add-asset-form" class="space-y-4">
                            <div>
                                <label for="add-asset-name" class="block text-sm font-medium text-gray-700">Nama Aset</label>
                                <input type="text" id="add-asset-name" required placeholder="Cth: Projektor BenQ"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="add-asset-type" class="block text-sm font-medium text-gray-700">Jenis</label>
                                    <select id="add-asset-type" required
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="Peranti">Peranti</option>
                                        <option value="Komponen">Komponen</option>
                                        <option value="Aksesori">Aksesori</option>
                                        <option value="Lain-lain">Lain-lain</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="add-asset-tag" class="block text-sm font-medium text-gray-700">Tag ID</label>
                                    <input type="text" id="add-asset-tag" placeholder="Cth: SKSA/ICT/P/01"
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                            </div>

                            <div>
                                <label for="add-asset-status" class="block text-sm font-medium text-gray-700">Status</label>
                                <select id="add-asset-status" required
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="Tersedia">Tersedia</option>
                                    <option value="Dipinjam">Dipinjam</option>
                                    <option value="Rosak">Rosak</option>
                                </select>
                            </div>

                            <div>
                                <label for="add-asset-specs" class="block text-sm font-medium text-gray-700">Spesifikasi (Satu per baris)</label>
                                <textarea id="add-asset-specs" rows="4" placeholder="Cth:&#10;RAM: 8GB&#10;CPU: Intel i5&#10;SSD: 256GB"
                                          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 font-mono text-sm"></textarea>
                            </div>
                            
                            <button type="submit" id="add-asset-submit"
                                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow transition duration-200">
                                Tambah Aset
                            </button>
                            <p id="add-asset-status-msg" class="text-sm text-green-600 text-center"></p>
                        </form>
                    </div>
                    
                    <!-- Kolum 2: Senarai Aset (Untuk Disunting) -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-900 mb-5">Urus Senarai Aset</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Aset</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tag ID</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Tindakan</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-asset-list" class="bg-white divide-y divide-gray-200">
                                    <!-- Baris aset akan dimuatkan di sini -->
                                    <tr><td colspan="4" class="px-4 py-4 text-sm text-gray-500 text-center">Memuatkan senarai aset...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Modal Edit Aset (Hanya Admin) -->
    <div id="edit-asset-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-30 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col transition-transform duration-300 scale-95" id="edit-asset-modal-content">
            
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-5 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-900">Kemas Kini Maklumat Aset</h3>
                <button id="close-edit-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- Modal Body (Boleh Skrol) -->
            <div class="p-6 overflow-y-auto">
                <form id="edit-asset-form" class="space-y-4">
                    <input type="hidden" id="edit-asset-id">
                    
                    <div>
                        <label for="edit-asset-name" class="block text-sm font-medium text-gray-700">Nama Aset</label>
                        <input type="text" id="edit-asset-name" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 bg-gray-100">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="edit-asset-type" class="block text-sm font-medium text-gray-700">Jenis</Labe>
                            <select id="edit-asset-type" required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 bg-gray-100">
                                <option value="Peranti">Peranti</option>
                                <option value="Komponen">Komponen</option>
                                <option value="Aksesori">Aksesori</option>
                                <option value="Lain-lain">Lain-lain</option>
                            </select>
                        </div>
                        <div>
                            <label for="edit-asset-tag" class="block text-sm font-medium text-gray-700">Tag ID</label>
                            <input type="text" id="edit-asset-tag"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 bg-gray-100">
                        </div>
                    </div>

                    <div>
                        <label for="edit-asset-status" class="block text-sm font-medium text-gray-700">Status</label>
                        <select id="edit-asset-status" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 bg-gray-100">
                            <option value="Tersedia">Tersedia</option>
                            <option value="Dipinjam">Dipinjam</option>
                            <option value="Rosak">Rosak</option>
                        </select>
                    </div>

                    <div>
                        <label for="edit-asset-specs" class="block text-sm font-medium text-gray-700">Spesifikasi (Satu per baris)</label>
                        <textarea id="edit-asset-specs" rows="4" placeholder="Cth:&#10;RAM: 8GB&#10;CPU: Intel i5&#10;SSD: 256GB"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 bg-gray-100 font-mono text-sm"></textarea>
                    </div>
                    
                    <div class="pt-4 border-t border-gray-200 space-y-3">
                        <button type="submit" id="edit-asset-submit"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-200">
                            Simpan Maklumat Aset
                        </button>
                        <!-- (BARU) Butang Salin ke Kumpulan -->
                        <button type="button" id="copy-to-group-btn"
                                class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-200">
                            Simpan & Salin Info ke Kumpulan
                        </button>
                        <p id="edit-asset-status" class="text-sm text-green-600 text-center"></p>
                    </div>
                </form>
            </div>
            
            <!-- Modal Footer (Butang Padam) -->
            <div class="flex justify-start p-5 border-t border-gray-200 bg-gray-50 rounded-b-xl">
                 <button type="button" id="delete-asset-btn"
                        class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-200">
                    Padam Aset Ini
                </button>
            </div>
        </div>
    </div>
    
    <!-- === PERMULAAN BLOK JAVASCRIPT === -->
    
    <script type="module">
        // Import fungsi Firebase yang diperlukan
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            writeBatch, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi Firebase yang anda berikan
        const firebaseConfig = {
          apiKey: "AIzaSyCV5skKQO1i-T6pOckTEyhDG8H4fh7vS7s",
          authDomain: "sistem-pinjaman-aset-ict-v2.firebaseapp.com",
          projectId: "sistem-pinjaman-aset-ict-v2",
          storageBucket: "sistem-pinjaman-aset-ict-v2.firebasestorage.app",
          messagingSenderId: "1013418266777",
          appId: "1:1013418266777:web:f3ec4d5f38fe7b87b76808",
          measurementId: "G-9CQDWM207Z"
        };

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Penyedia Auth
        const googleProvider = new GoogleAuthProvider();

        // Pembolehubah status global
        let currentUserId = null;
        let isAdmin = false;

        // --- PENGENDALI ELEMEN DOM ---
        // Paparan
        const loadingView = document.getElementById('loading-view');
        const authView = document.getElementById('auth-view');
        const appView = document.getElementById('app-view');
        
        // Butang Auth
        const googleBtn = document.getElementById('google-signin-btn');
        const anonBtn = document.getElementById('anonymous-signin-btn');
        const signOutBtn = document.getElementById('signout-btn');

        // Paparan Info Pengguna
        const userEmailDisplay = document.getElementById('user-email-display');
        const userRoleDisplay = document.getElementById('user-role-display');
        const adminControls = document.querySelectorAll('.admin-controls'); // Ini adalah NodeList

        // --- LOGIK PENGESAHAN (AUTH) ---

        // Log masuk dengan Google
        googleBtn.onclick = () => {
            signInWithPopup(auth, googleProvider)
                .catch((error) => {
                    console.error("Ralat log masuk Google:", error);
                    alert("Gagal log masuk dengan Google: " + error.message);
                });
        };

        // Log masuk secara anonymous
        anonBtn.onclick = () => {
            signInAnonymously(auth)
                .catch((error) => {
                    console.error("Ralat log masuk anonymous:", error);
                    alert("Gagal log masuk sebagai guru: " + error.message);
                });
        };

        // Log keluar
        signOutBtn.onclick = () => {
            signOut(auth).catch((error) => {
                console.error("Ralat log keluar:", error);
            });
        };

        // Pendengar status pengesahan (PENGAWAL UTAMA APLIKASI)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Pengguna telah log masuk
                currentUserId = user.uid;
                
                // Semak jika admin (bukan anonymous), berdasarkan peraturan Firebase anda
                isAdmin = user.providerData.length > 0 && user.providerData[0].providerId !== 'anonymous';

                // Kemas kini UI
                userEmailDisplay.textContent = user.email || (user.isAnonymous ? 'Pengguna Anonymous' : 'Pengguna');
                userEmailDisplay.title = user.email || (user.isAnonymous ? 'Pengguna Anonymous' : 'Pengguna');
                userRoleDisplay.textContent = isAdmin ? 'Pentadbir' : 'Guru (Mod Pinjam)';

                // Tunjukkan/sembunyikan kawalan admin
                adminControls.forEach(el => {
                    el.classList.toggle('hidden', !isAdmin);
                });

                // Tukar paparan
                appView.classList.remove('hidden');
                authView.classList.add('hidden');
                loadingView.classList.add('hidden');
                
                // Mula memuatkan data dari Firestore
                loadAssets();
                loadLoans();

            } else {
                // Pengguna telah log keluar
                currentUserId = null;
                isAdmin = false;

                // Tukar paparan
                appView.classList.add('hidden');
                authView.classList.remove('hidden');
                loadingView.classList.add('hidden');

                // Kosongkan data lama
                clearDataLists();
            }
        });

        // --- LOGIK FIRESTORE (DATA) ---
        // (Rangka fungsi - perlu dilengkapkan)

        /**
         * Memuatkan semua aset dari koleksi 'items'
         */
        function loadAssets() {
            console.log("Memuatkan aset...");
            const itemsCollection = collection(db, 'items');
            
            // TODO: Gunakan onSnapshot untuk mendengar perubahan masa nyata
            // onSnapshot(itemsCollection, (snapshot) => { ... });
            
            // Rangka untuk paparan:
            // const assetGrid = document.getElementById('asset-grid');
            // const adminAssetList = document.getElementById('admin-asset-list');
            // const newLoanAssetSelect = document.getElementById('new-loan-asset');
            // Kosongkan senarai
            // assetGrid.innerHTML = '';
            // adminAssetList.innerHTML = '';
            // newLoanAssetSelect.innerHTML = '<option value="" disabled selected>Pilih aset...</option>';
            
            // snapshot.docs.forEach(doc => {
            //     const asset = { id: doc.id, ...doc.data() };
            //     // Tambah pada grid, senarai admin, dan dropdown
            // });
        }

        /**
         * Memuatkan semua pinjaman dari koleksi 'loans'
         */
        function loadLoans() {
            console.log("Memuatkan pinjaman...");
            const loansCollection = collection(db, 'loans');
            
            // TODO: Gunakan onSnapshot untuk mendengar perubahan masa nyata
            // onSnapshot(loansCollection, (snapshot) => { ... });

            // Rangka untuk paparan:
            // const pendingList = document.getElementById('loan-list-pending');
            // const approvedList = document.getElementById('loan-list-approved');
            // const historyList = document.getElementById('loan-list-history');
            // Kosongkan senarai
            // pendingList.innerHTML = '';
            // approvedList.innerHTML = '';
            // historyList.innerHTML = '';

            // snapshot.docs.forEach(doc => {
            //     const loan = { id: doc.id, ...doc.data() };
            //     // Asingkan ke senarai yang betul berdasarkan loan.status
            //     if (loan.status === 'Pending') {
            //         // ...
            //     } else if (loan.status === 'Approved') {
            //         // ...
            //     } else {
            //         // ...
            //     }
            // });
        }

        /**
         * Mengosongkan semua senarai data (digunakan semasa log keluar)
         */
        function clearDataLists() {
            document.getElementById('asset-grid').innerHTML = '<p class="text-gray-500 text-sm col-span-full">Sila log masuk untuk melihat aset.</p>';
            document.getElementById('admin-asset-list').innerHTML = '<tr><td colspan="4" class="px-4 py-4 text-sm text-gray-500 text-center">Sila log masuk untuk mengurus aset.</td></tr>';
            document.getElementById('new-loan-asset').innerHTML = '<option value="" disabled selected>Pilih aset...</option>';
            document.getElementById('loan-list-pending').innerHTML = '<p class="text-gray-500 text-sm">Tiada permohonan baharu.</p>';
            document.getElementById('loan-list-approved').innerHTML = '<p class="text-gray-500 text-sm">Tiada aset sedang dipinjam.</p>';
            document.getElementById('loan-list-history').innerHTML = '<p class="text-gray-500 text-sm">Tiada sejarah pinjaman.</p>';
        }

        // --- PENGENDALI 'EVENT LISTENER' UNTUK BORANG ---
        // (Rangka - perlu dilengkapkan)

        document.getElementById('new-loan-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!currentUserId) return; // Mesti log masuk
            
            console.log("Menghantar borang pinjaman...");
            // TODO: Dapatkan nilai dari 'new-loan-name', 'new-loan-class', dll.
            // TODO: Gunakan addDoc(collection(db, 'loans'), { ... })
            // Jangan lupa tambah 'status: "Pending"', 'userId: currentUserId'
        });

        document.getElementById('add-asset-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!isAdmin) return; // Mesti admin
            
            console.log("Menghantar borang aset baharu...");
            // TODO: Dapatkan nilai dari 'add-asset-name', 'add-asset-type', dll.
            // TODO: Gunakan addDoc(collection(db, 'items'), { ... })
        });
        
        document.getElementById('edit-asset-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!isAdmin) return; // Mesti admin
            
            console.log("Menyimpan perubahan aset...");
            // const assetId = document.getElementById('edit-asset-id').value;
            // TODO: Dapatkan nilai dari 'edit-asset-name', 'edit-asset-type', dll.
            // TODO: Gunakan setDoc(doc(db, 'items', assetId), { ... })
        });
        
        document.getElementById('delete-asset-btn').addEventListener('click', () => {
            if (!isAdmin) return; // Mesti admin
            
            // const assetId = document.getElementById('edit-asset-id').value;
            // if (confirm(`Adakah anda pasti mahu memadam aset ini? (ID: ${assetId})`)) {
            //     console.log("Memadam aset...");
            //     // TODO: Gunakan deleteDoc(doc(db, 'items', assetId))
            // }
        });
        
        document.getElementById('close-edit-modal-btn').addEventListener('click', () => {
             document.getElementById('edit-asset-modal').classList.add('hidden');
        });

    </script>
    
</body>
</html>
